---
title: "MODIS SDM"
author: "Jeff Oliver"
date: "11/8/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Summary

An investigation into the use of MODIS land-cover data for use in species 
distribution models.

## Investingating options through MODISTools

```{r modis-check}
library(MODISTools)
products <- mt_products()
head(products)
land_cover_rows <- grep(pattern = "cover", x = products$description, ignore.case = TRUE, )
print(land_cover_rows)
products[land_cover_rows, c("product", "description")]
prod_name <- "MCD12Q1"
```

We want MCD12Q1, the land cover type. What bands are available?

```{r modis-bands}
bands <- mt_bands(product = prod_name)
print(bands$description)
```

Download some land cover data (IGBP) for the Sonoran Desert

```{r sonoran-land-cover}
sonoran_lc <- mt_subset(product = "MCD12Q1",
  lat = 31.997188, 
  lon =  -111.849792,
  band = "LC_Type1",
  start = "2004-01-01",
  end = "2004-3-20",
  km_lr = 10, # max value is 100; may need to stitch
  km_ab = 10,
  site_name = "sonoran",
  internal = TRUE,
  progress = TRUE)
```

## Different approach, download raster

Example of how to download raster land cover data from modis:
[https://rspatialdata.github.io/land_cover.html](https://rspatialdata.github.io/land_cover.html)

```{r modis-layes}
library(MODIStsp)
# See what we can get from MODIS
MODIStsp_get_prodlayers("MCD12Q1")
```

First want a positive control test?

```{r zim-test}
# remotes::install_github("wmgeolab/rgeoboundaries")
# install.packages("sf")
library(rgeoboundaries)
library(sf)
# Downloading the country boundary of Zimbabwe
map_boundary <- geoboundaries("Zimbabwe")
# Defining filepath to save downloaded spatial file
spatial_filepath <- "data/zimbabwe.shp"
# Saving downloaded spatial file on to our computer
st_write(map_boundary, paste0(spatial_filepath))

# This times out (authentication issue with credentials) 2021-11-09:
# Worked once as of 2021-11-11
# On re-try, timed out three times, then worked
MODIStsp(gui             = FALSE,
         out_folder      = "data",
         out_folder_mod  = "data",
         selprod         = "LandCover_Type_Yearly_500m (MCD12Q1)",
         bandsel         = "LC1",
         user            = "mstp_test" ,
         password        = "MSTP_test_01",
         start_date      = "2019.01.01",
         end_date        = "2019.12.31",
         verbose         = TRUE,
         spatmeth        = "file",
         spafile         = spatial_filepath,
         out_format      = "GTiff")
```



Want to try to get the first band (IGBP) for data relevant to saguaros.

Doesn't currently work - times out after four tries...2021-11-09

```{r download-sonoran-raster}
# Note markdown current directory is directory of markdown file, not 
# necessarily output of getwd()
username <- scan(file = "../keys/earthdata-username.txt", what = character())
password <- scan(file = "../keys/earthdata-password.txt", what = character())

# Boundary of interest (left, bottom, right, top)
bounds <- c(-114, 26, -109, 35)
# See https://modis-land.gsfc.nasa.gov/pdf/sn_bound_10deg.txt
# Download to data file, not worrying about projection for now
wkt_proj <- 'GEOGCS["WGS 84",DATUM["WGS_1984",SPHEROID["WGS 84",6378137,298.257223563,AUTHORITY["EPSG","7030"]],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0,AUTHORITY["EPSG","8901"]],UNIT["degree",0.01745329251994328,AUTHORITY["EPSG","9122"]],AUTHORITY["EPSG","4326"]]'
  
library(MODIStsp)
MODIStsp(gui = FALSE,
         out_folder = "data", # inside dev-scripts
         out_folder_mod = "data", # inside dev-scripts
         selprod         = "LandCover_Type_Yearly_500m (MCD12Q1)",
         bandsel         = "LC1", 
         user            = username,
         password        = password,
         start_date      = "2019.01.01", 
         end_date        = "2019.12.31", 
         verbose = TRUE,
         reprocess = TRUE,
         spatmeth = "bbox",
         bbox = bounds,
         out_projsel = "User Defined",
         # output_proj = "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs", # A WGS84 projection
         output_proj = wkt_proj,
         out_format = "GTiff")
```

## 2021-11-09
Consistently timing out. Checking [https://docs.ropensci.org/MODIStsp/articles/faq.html#data-download-problems](https://docs.ropensci.org/MODIStsp/articles/faq.html#data-download-problems). Had to explicitly check 
to be authorized to use LP DAAC Data Pool

+ Updating the package (and all dependencies); using development version from 
GitHub. If it still doesn't work try `get_mod_dirs()`
+ Also, try using the interactive option, with `gui = TRUE`

## 2021-11-11
Worked, although still has timeouts occasionally.

Plot below works, too. Next step is to try sdm.

```{r plot-raster}
library(raster)
library(ggplot2)
library(dplyr)
# Load in raster from file
IGBP_raster <- raster(x = "data/LandCover_Type_Yearly_500m_v6/LC1/MCD12Q1_LC1_2019_001.tif")

# Convert to a data frame for plotting
IGBP_df <- as.data.frame(IGBP_raster, xy = TRUE, na.rm = TRUE) %>%
  mutate(MCD12Q1_LC1_2019_001 = as.factor(round(MCD12Q1_LC1_2019_001)))

rownames(IGBP_df) <- c()
# Renaming IGBP classification levels
levels(IGBP_df$MCD12Q1_LC1_2019_001) <- c( "Evergreen needleleaf forests",
                                           "Evergreen broadleaf forests",
                                           "Deciduous needleleaf forests",
                                           "Deciduous broadleaf forests",
                                           "Mixed forests",
                                           "Closed shrublands",
                                           "Open shrublands",
                                           "Woody savannas",
                                           "Savannas",
                                           "Grasslands",
                                           "Permanent wetlands",
                                           "Croplands",
                                           "Urban and built-up lands",
                                           "Cropland/natural vegetation mosaics",
                                           "Snow and ice",
                                           "Barren",
                                           "Water bodies")
# Visualising using ggplot2
ggplot() + 
  geom_raster(data = IGBP_df,
              aes(x = x, y = y, fill = MCD12Q1_LC1_2019_001)) +
  scale_fill_viridis_d(name = "Land Cover Type") +
  labs(subtitle = "2019-01-01 - 2019-12-31",
       x = "Longitude",
       y = "Latitude") +
  theme_minimal()
```

