---
title: "Mapping with Open Street Maps in R"
author: "Jeff Oliver"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document: default
  pdf_document:
    latex_engine: xelatex
urlcolor: blue
---

An introduction to working with Open Street Map data in R.

#### Learning objectives
1. Install the osmdata R package
2. Investigate data available from Open Street Maps
3. Create a street map with restaurants in Tucson

[OpenStreetMap](https://www.openstreetmap.org/about) is a source of several 
geographic data that you can use for analysis and visualization. The package 
osmdata allows you to work with those data through R. In this workshop, we will 
use osmdata and associated package to investigate OpenStreetMap data and use 
them for geographical visualization.

***

## Getting started

We are going to be using the R language, with the RStudio IDE, so if you have 
not already installed those pieces of software, you can find download links
for both at the [installation page](https://jcoliver.github.io/learn-r/000-setup-instructions.html).

First we need to setup our development environment. Open RStudio and create a 
new project via:

+ File > New Project...
+ Select 'New Directory'
+ For the Project Type select 'New Project'
+ For Directory name, call it something like "osm-lesson" (without the quotes)
+ For the subdirectory, select somewhere you will remember (like "My Documents" 
or "Desktop")

The R software comes with lots of great features, but one of the best parts of 
R is that there are lots of add-ons that you can use. These are called 
"packages" and have to be explicitly installed to use them. The focus of 
today's lesson is going to be the osmdata package, which lets us interface with 
OpenStreetMap data. We are also going to use some packages for visualizing our 
map, so we will install those, too. To install packages, we use the command 
`install.packages()`; you can type and run the two commands into the console in 
RStudio:

```{r install-packages, eval = FALSE}
install.packages("osmdata") # For getting and working with OpenStreetMap data
install.packages("ggplot2") # For data visualization
```

***

## Interrogating OpenStreetMap data

When using packages like osmdata and ggplot2, we have to take one additional 
step to actually _use_ them. Whenever we want to use those packages, we need to 
load them explicitly with the `library()` command:

```{r load-libraries, eval = FALSE}
library(osmdata)
library(ggplot2)
```

```{r load-libraries-print, echo = FALSE}
suppressPackageStartupMessages(library(osmdata))
suppressPackageStartupMessages(library(ggplot2))
```

Let's start by looking at what kind of data are available through 
OpenStreetMap. I usually start with `available_features()` to see the top-level 
data organization:

```{r feature-check, eval = FALSE}
# List the features of OSM data
available_features()
```

```{r feature-check-print, echo = FALSE}
tail(available_features(), n = 20)
```

(we are just seeing the last twenty entries, you will probably see something in 
the neighborhood of 230 different features.)

In the list that printed out, note there is one called "water". We can look 
further into these features to see what _kinds_ of water data are in OSM. We 
use the function `available_tags()` and ask for tags for a particular feature.
In this case, we will look for the tags of those water features:

```{r tag-check}
available_tags(feature = "water")
```

Note that not all features have attributes. For example, the feature "tunnel" 
has no additional attributes; when you run `available_tags()` on a feature 
without those additional attributes, the output will be `character(0)`:

```{r no-tags}
available_tags(feature = "tunnel")
```

If you want to take a deep dive into all the features, check out the OSM 
[wiki page on map features](https://wiki.openstreetmap.org/wiki/Map_features).

***

## But, what about maps?

Like any kind of data visualization, building maps is an interative process. 
Here we are going to start with defining the geographic area we are interested
in then add features to that area.

### Where are we going?

There are two ways we can define our area of interest:

1. Manually defining the latitude and longitude coordinates of a bounding box.
2. Using OSM place names to automatically create the bounding box.

The first option gives you complete control over the bounding box, but the 
second option is much easier.

If you want to do it the first way, you create a 2x2 matrix with four values 
(min/max longitude and min/max latitude). In order to play nice with the 
osmdata package, we also name the columns and rows accordingly:

```{r tucson-bb-matrix}
# A 2x2 matrix
tucson_bb <- matrix(data = c(-111.0, -110.7, 31.0, 32.3),
                    nrow = 2,
                    byrow = TRUE)
# Update column and row names
colnames(tucson_bb) <- c("min", "max")
rownames(tucson_bb) <- c("x", "y")
# Print the matrix to the console
tucson_bb
```

Now, control freaks like me might really like this approach, but the second 
option presents a much easier way:

```{r tucson-bb-osmdata}
# Use the bounding box defined for Tucson by OSM
tucson_bb <- getbb("Tucson")
# Print the matrix to the console
tucson_bb
```

This probably provides a better bounding box than my guesses at latitude and 
longitude, so we will use this second approach.

### Roads? Where we're going we...definitely need roads

We'll start by adding roads to our map. For our purposes, we will have big 
roads and small roads. This is a pretty artificial distinction, but it works 
for our map. For the OSM data, we want to use data from the "highway" feature, 
so we start by looking to see what tags are available for that feature:

```{r highway-tags}
available_tags(feature = "highway")
```

Okayyyyy, that's a lot. We are going to just use a subset of those tags, but 
you can look at them all in depth on the 
[OSM Wiki](https://wiki.openstreetmap.org/wiki/Map_features#Highway). We will 
start with just the major roads. We start by getting the bounding box for 
Tucson, then creating a query for the database with `opq()`, specifying which 
features we want with `add_osm_feature()`, and finally converting it to simple 
feature (sf) format with `osmdata_sf()`.

```{r major-roads}
tucson_major <- getbb(place_name = "Tucson") %>%
  opq() %>%
  add_osm_feature(key = "highway", 
                  value = c("motorway", "primary", "secondary")) %>%
  osmdata_sf()
```

In the code above, we chain together multiple commands with the pipe operator 
(`%>%`). When you see the pipe, you can interpret this as the words "and then".
If we wrote this as pseudocode, it would read:

```
tucson_major <- get the bounding box for Tucson *and then*
  prepare an OSM query *and then*
  specify the types of highways to include *and then*
  convert the data to sf format
```

Looking at this object, it provides a little information about the geographic 
extent and how many points, lines, and polygons are returned:

```{r major-roads-print}
tucson_major
```


```{r}
street_plot <- ggplot() +
  geom_sf(data = tucson_major$osm_lines,
          inherit.aes = FALSE,
          color = "black",
          size = 0.2)
# street_plot

tucson_minor <- getbb(place_name = "Tucson") %>%
  opq() %>%
  add_osm_feature(key = "highway", value = c("tertiary", "residential")) %>%
  osmdata_sf()

street_plot <- street_plot +
  geom_sf(data = tucson_minor$osm_lines,
          inherit.aes = FALSE,
          color = "#666666",
          size = 0.1)
# street_plot

# street_plot <- street_plot +
#   coord_sf(ylim = c(32.1, 32.3), # odd behavior only allows us to set x or y
#            expand = FALSE)
# street_plot

```


***

## [TOPIC THREE]
Add features like restaurants

```{r restaurants}

# Query for Tucson restaurants
tucson_rest <- getbb(place_name = "Tucson") %>%
  opq() %>%
  add_osm_feature(key = "amenity", value = "restaurant")

# str(tucson_rest)

restaurants <- osmdata_sf(tucson_rest)
# restaurants


# Idiosyncratic? Sometimes have to start from getbb scratch...
tucson_mex <- tucson_rest %>%
  add_osm_feature(key = "cuisine", value = "mexican")

# str(tucson_mex)

mex <- osmdata_sf(tucson_mex)
# mex

# Now use that streetmap and add the restaurants
rest_plot <- street_plot +
  geom_sf(data = mex$osm_points,
          inherit.aes = FALSE,
          size = 1.5,
          color = "#1B9E77") +
  coord_sf(ylim = c(32.1, 32.3),
           expand = FALSE) +
  theme_void()

rest_plot
```

***

## [TOPIC FOUR]

```{r external-data}
# Download Harris' Hawk observations (source: iNaturalist)
# TODO: Replace with tinyurl
hh_obs <- read.csv(file = "https://bit.ly/hh-obs")
head(hh_obs)

hawk_plot <- street_plot + 
  geom_point(data = hh_obs,
             mapping = aes(x = longitude, y = latitude),
             color = "#D95F02",
             size = 1, 
             inherit.aes = FALSE) +
  coord_sf(ylim = c(32.1, 32.3),
           expand = FALSE) +
  theme_void()


```

***

## Additional resources

+ The [osmdata package on GitHub](https://github.com/ropensci/osmdata)
+ The [OSM Wiki page](https://wiki.openstreetmap.org/wiki/Main_Page)
+ The wiki page on [map features](https://wiki.openstreetmap.org/wiki/Map_features)
+ A tutorial on osmdata [mapping roads in Asheville, NC](http://joshuamccrain.com/tutorials/maps/streets_tutorial.html)
+ An example [mapping movie theaters in Spain](https://dominicroye.github.io/en/2018/accessing-openstreetmap-data-with-r/)
+ A [PDF version](https://jcoliver.github.io/learn-r/lesson-name.pdf) of this lesson

***

<a href="index.html">Back to learn-r main page</a>
  
Questions?  e-mail me at <a href="mailto:jcoliver@arizona.edu">jcoliver@arizona.edu</a>.